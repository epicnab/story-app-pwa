import{E as r}from"./index-CZauPiH2.js";const a="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function c(t){try{const n="=".repeat((4-t.length%4)%4),i=(t+n).replace(/-/g,"+").replace(/_/g,"/"),e=atob(i);return Uint8Array.from([...e].map(o=>o.charCodeAt(0)))}catch(n){throw new Error(`Invalid Base64 string for VAPID key: ${n.message}`)}}async function s(){if(!("serviceWorker"in navigator)||!("PushManager"in window)){console.warn("Push notification not supported");return}const t=await navigator.serviceWorker.ready;if(await Notification.requestPermission()!=="granted"){console.warn("Notification permission denied");return}const i=c(a),e=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:i});await u(e)}async function u(t){const n=localStorage.getItem("token");if(!n)throw new Error("No authentication token");const i={endpoint:t.endpoint,keys:{p256dh:t.toJSON().keys.p256dh,auth:t.toJSON().keys.auth}},e=await fetch(r.SUBSCRIBE_NOTIFICATIONS,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(i)});if(!e.ok){const o=await e.json().catch(()=>({message:"Unknown error"}));throw new Error(`Failed to send push subscription: ${o.message}`)}console.log("Push subscription sent successfully")}async function g(){if(!("serviceWorker"in navigator)||!("PushManager"in window)){console.warn("Push notification not supported");return}const n=await(await navigator.serviceWorker.ready).pushManager.getSubscription();n&&(await n.unsubscribe(),await p(n))}async function p(t){const n=localStorage.getItem("token");if(!(await fetch(r.SUBSCRIBE_NOTIFICATIONS,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({endpoint:t.endpoint})})).ok)throw new Error("Failed to send push unsubscription");console.log("Push unsubscription sent successfully")}async function d(){return!("serviceWorker"in navigator)||!("PushManager"in window)?!1:!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}async function h(){return await d()?(await g(),!1):(await s(),!0)}async function w(){if(localStorage.getItem("token")&&"serviceWorker"in navigator&&"PushManager"in window)try{await(await navigator.serviceWorker.ready).pushManager.getSubscription()||await s()}catch(n){console.warn("Auto-subscribe failed:",n)}}export{w as initPushNotification,d as isPushNotificationEnabled,s as subscribePushNotification,h as togglePushNotification,g as unsubscribePushNotification};
