import{C as r}from"./index-XcmAEeCF.js";let o=null;async function c(){const t=localStorage.getItem("token");if(!t)throw new Error("User not authenticated");const i=await fetch(`${r.BASE_URL}/notifications/keys`,{headers:{Authorization:`Bearer ${t}`}});if(!i.ok)throw new Error("Failed to fetch VAPID key");return(await i.json()).vapidPublicKey}function u(t){const i="=".repeat((4-t.length%4)%4),n=(t+i).replace(/-/g,"+").replace(/_/g,"/"),e=window.atob(n);return Uint8Array.from([...e].map(s=>s.charCodeAt(0)))}async function a(){if(!("serviceWorker"in navigator)||!("PushManager"in window)){console.warn("Push notification not supported");return}const t=await navigator.serviceWorker.ready;if(await Notification.requestPermission()!=="granted"){console.warn("Notification permission denied");return}const n=await c(),e=u(n);o=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e}),await g(o)}async function g(t){const i=localStorage.getItem("token");if(!(await fetch(`${r.BASE_URL}/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(t)})).ok)throw new Error("Failed to send push subscription");console.log("Push subscription sent successfully")}async function p(){if(!("serviceWorker"in navigator)||!("PushManager"in window)){console.warn("Push notification not supported");return}const i=await(await navigator.serviceWorker.ready).pushManager.getSubscription();i&&(await i.unsubscribe(),await l(i),o=null)}async function l(t){const i=localStorage.getItem("token");if(!(await fetch(`${r.BASE_URL}/notifications/unsubscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(t)})).ok)throw new Error("Failed to send push unsubscription");console.log("Push unsubscription sent successfully")}async function f(){return!("serviceWorker"in navigator)||!("PushManager"in window)?!1:!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}async function d(){return await f()?(await p(),!1):(await a(),!0)}async function h(){if(console.log("Push notification initialized"),localStorage.getItem("token")&&"serviceWorker"in navigator&&"PushManager"in window)try{await(await navigator.serviceWorker.ready).pushManager.getSubscription()||await a()}catch(i){console.warn("Auto-subscribe failed:",i)}}export{h as initPushNotification,f as isPushNotificationEnabled,a as subscribePushNotification,d as togglePushNotification,p as unsubscribePushNotification};
