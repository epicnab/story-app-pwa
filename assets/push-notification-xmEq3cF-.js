import{C as r}from"./index-BkwdLjqO.js";let o=null;async function c(){const i=localStorage.getItem("token");if(!i)throw new Error("User not authenticated");const t=await fetch(`${r.BASE_URL}/notifications/keys`,{headers:{Authorization:`Bearer ${i}`}});if(!t.ok)throw new Error("Failed to fetch VAPID key");return(await t.json()).vapidPublicKey}function u(i){const t="=".repeat((4-i.length%4)%4),n=(i+t).replace(/-/g,"+").replace(/_/g,"/"),e=window.atob(n);return Uint8Array.from([...e].map(s=>s.charCodeAt(0)))}async function a(){if(!("serviceWorker"in navigator)||!("PushManager"in window)){console.warn("Push notification not supported");return}const i=await navigator.serviceWorker.ready;if(await Notification.requestPermission()!=="granted"){console.warn("Notification permission denied");return}const n=await c(),e=u(n);o=await i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e}),await g(o)}async function g(i){const t=localStorage.getItem("token");if(!t)throw new Error("No authentication token");const n=await fetch(`${r.BASE_URL}/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(i)});if(!n.ok){const e=await n.json().catch(()=>({message:"Unknown error"}));throw new Error(`Failed to send push subscription: ${e.message}`)}console.log("Push subscription sent successfully")}async function p(){if(!("serviceWorker"in navigator)||!("PushManager"in window)){console.warn("Push notification not supported");return}const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();t&&(await t.unsubscribe(),await w(t),o=null)}async function w(i){const t=localStorage.getItem("token");if(!(await fetch(`${r.BASE_URL}/notifications/unsubscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(i)})).ok)throw new Error("Failed to send push unsubscription");console.log("Push unsubscription sent successfully")}async function f(){return!("serviceWorker"in navigator)||!("PushManager"in window)?!1:!!await(await navigator.serviceWorker.ready).pushManager.getSubscription()}async function d(){return await f()?(await p(),!1):(await a(),!0)}async function h(){if(localStorage.getItem("token")&&"serviceWorker"in navigator&&"PushManager"in window)try{await(await navigator.serviceWorker.ready).pushManager.getSubscription()||await a()}catch(t){console.warn("Auto-subscribe failed:",t)}}export{h as initPushNotification,f as isPushNotificationEnabled,a as subscribePushNotification,d as togglePushNotification,p as unsubscribePushNotification};
